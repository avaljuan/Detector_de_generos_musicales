---
title: "funcion_espectrograma"
author: "Carlos"
date: "2025-12-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tuneR)
library(seewave)

# FUNCIÓN :  Espectrogramas Estándar
# Entrada: Vector de rutas de archivos c("a.mp3", "b.mp3")
# Salida: Una lista de matrices de amplitud
# ---------------------------------------------------------
obtener_lista_espectrogramas <- function(lista_archivos) {
  
  # Inicializamos una lista vacía para guardar los resultados
  resultados <- list()
  
  message(paste("Iniciando procesamiento de", length(lista_archivos), "archivos..."))
  
  for (i in seq_along(lista_archivos)) {
    archivo <- lista_archivos[i]
    nombre_archivo <- basename(archivo)
    
    # Bloque de seguridad para evitar que un error pare todo el bucle
    tryCatch({
      # Leer MP3
      onda <- readMP3(archivo)
      onda <- mono(onda, which = "both") # Convertir a mono
      
      # Calcular Espectrograma
      # wl = 512 es una resolución estándar.
      spec <- spectro(onda, wl = 512, plot = FALSE)
      
      # 3. Guardar la matriz en la lista con el nombre del archivo
      resultados[[nombre_archivo]] <- spec$amp
      
      
      
    }, error = function(e) {
      warning(paste("Error en archivo:", nombre_archivo, "-", e$message))
    })
  }
  
  return(resultados)
}

# ---------------------------------------------------------
# FUNCIÓN : Espectrogramas MEL 
# Entrada: Vector de rutas de archivos
# Salida: Lista de matrices Mel
# ---------------------------------------------------------
obtener_lista_espectrogramas_mel <- function(lista_archivos, num_bandas = 40) {
  
  resultados_mel <- list()
  
  message(paste("Calculando Mel Spectrograms para", length(lista_archivos), "archivos..."))
  
  for (i in seq_along(lista_archivos)) {
    archivo <- lista_archivos[i]
    nombre_archivo <- basename(archivo)
    
    tryCatch({
      # Leer MP3
      onda <- readMP3(archivo)
      onda <- mono(onda, which = "both")
      frecuencia <- onda@samp.rate
      
      # Espectrograma base
      spec_base <- spectro(onda, wl = 512, plot = FALSE)
      
      # Filtro MEL (Lo que realmente usará el clasificador)
      # Devuelve una matriz de (num_bandas x Tiempo)
      mel_spec <- melfilterbank(spec_base$amp, f = frecuencia, 
                                wl = 512, m = num_bandas, plot = FALSE)
      
      # Guardamos la matriz
      resultados_mel[[nombre_archivo]] <- mel_spec
      
      if(i %% 5 == 0) message(paste("Mel procesado:", i, "/", length(lista_archivos)))
      
    }, error = function(e) {
      warning(paste("Error Mel en:", nombre_archivo, "-", e$message))
    })
  }
  
  return(resultados_mel)
}
```
```{r}
mis_archivos <- list.files(
  path = "./canciones",  # La carpeta donde están los audios
  pattern = "\\.mp3$",                # Expresión regular: solo archivos que terminan en .mp3
  full.names = TRUE,                  # IMPORTANTE: Devuelve la ruta completa ("carpeta/audio.mp3")
  ignore.case = TRUE                  # Para que detecte .mp3 y .MP3
)

# Ver el resultado
print(mis_archivos)
obtener_lista_espectrogramas(mis_archivos)
```


