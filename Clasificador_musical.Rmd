---
title: "Clasificador_generos"
author: "Axel Valton"
date: "2026-01-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
#Obtenemos los nombres de los archivos de features
```{r}
features <- list.files(path=".")[grepl(pattern="features.*",x=list.files(path="."))]
```



#Cargamos y creamos el dataframe

```{r}
library(readr)
features_music <- NULL
for (nombre in features){
  features_genero <-  read_csv(nombre)
  features_music <- rbind(features_music, features_genero)
}


View(features_music)
```
#Convertimos a factor la columna Genero
```{r}
features_music$Genero <- as.factor(features_music$Genero)
features_music <- features_music %>% 
  select(-Song_Name,-mfcc_2,-Centroid)
```

#Creamos la partición en train-test

```{r}
library(caret)
pacman::p_load(randomForest)
set.seed(123) # Para que los resultados sean reproducibles

# Creamos los índices para el 70% de entrenamiento
trainIndex <- createDataPartition(features_music$Genero, p = 0.7, list = FALSE)

train_data <- features_music[trainIndex, ]
test_data  <- features_music[-trainIndex, ]
```

# Entrenamos con balanceo de clases

```{r}
# Buscamos cuántas muestras tiene el género con menos canciones
n_min <- min(table(train_data$Genero))

# Entrenar el Random Forest con Balanceo
rf_model <- randomForest(
  Genero ~ ., 
  data = train_data, 
  ntree = 500,           # Número de árboles
  importance = TRUE,     # Para ver qué variables son más importantes
  sampsize = rep(n_min, length(levels(train_data$Genero))), # BALANCEO AQUÍ
  strata = train_data$Genero
)

print(rf_model)
```
```{r}
library(dplyr)

# 1. Extraemos las predicciones hechas sobre el propio set de entrenamiento
# El modelo guarda sus predicciones 'internas' en rf_model$predicted
predicciones_entrenamiento <- rf_model$predicted

# 2. Creamos la tabla de errores comparando con los datos originales de train_data
errores_entrenamiento <- train_data %>%
  mutate(Prediccion_OOB = predicciones_entrenamiento) %>%
  filter(Genero != Prediccion_OOB) %>%
  select(Genero, Prediccion_OOB)

# 3. Ver las canciones que causaron confusión
print(errores_entrenamiento)

# Opcional: ¿Cuántas veces se equivocó exactamente en cada cruce?
table(Reales = errores_entrenamiento$Genero, Predichas = errores_entrenamiento$Prediccion_OOB)
```

#Predecimos y generamos la matriz de confusión
```{r}
# Predecir en el set de prueba
predicciones <- predict(rf_model, test_data)

# Matriz de Confusión (ver aciertos y errores)
mc <- confusionMatrix(predicciones, test_data$Genero)
print(mc)
```

#Analizamos importancia de características

```{r}
library(ggplot2)
library(dplyr)

# 1. Extraer la importancia y convertirla en un dataframe
importancia_df <- as.data.frame(importance(rf_model))
importancia_df$Variable <- rownames(importancia_df)

# 2. Quedarnos con el "MeanDecreaseGini" (pureza del nodo) o "MeanDecreaseAccuracy"
# Vamos a ordenar por MeanDecreaseGini
importancia_df <- importancia_df %>%
  arrange(desc(MeanDecreaseGini))

# 3. Graficar
ggplot(importancia_df, aes(x = reorder(Variable, MeanDecreaseGini), y = MeanDecreaseGini)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  coord_flip() + # Girar para que se lean bien los nombres
  labs(title = "Importancia de las Características (Gini Index)",
       x = "Variables",
       y = "Importancia (Mean Decrease Gini)") +
  theme_minimal()
```
# Analizamos correlaciones
```{r}
if(!require(corrplot)) install.packages("corrplot")
library(corrplot)


predictores_num <- features_music %>%
  select(where(is.numeric)) 

# Calcular la matriz de correlación
matriz_cor <- cor(predictores_num, use = "complete.obs")

# Configurar una paleta de colores profesional
colores_profesionales <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))(200)


# Ajustamos los márgenes para que no se corte el título
par(mar = c(1, 1, 3, 1)) 

corrplot(matriz_cor, 
         method = "circle",       
         type = "lower",          
         order = "hclust",        
         col = colores_profesionales, 
         tl.col = "black",       
         tl.srt = 45,            
         tl.cex = 0.7,            
         cl.ratio = 0.2,          
         title = "Mapa de Correlaciones (Tamaño y Color)"
)
```






